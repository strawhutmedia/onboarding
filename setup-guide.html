<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Apps Script Setup — Straw Hut Media</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #0f1225; color: #e2e4e8; min-height: 100vh; padding: 40px 24px; }
    .container { max-width: 700px; margin: 0 auto; }
    h1 { font-size: 24px; font-weight: 800; color: #fff; margin-bottom: 8px; }
    .subtitle { color: #9ca3af; font-size: 15px; margin-bottom: 32px; }
    .step { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 24px; margin-bottom: 16px; }
    .step-num { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: rgba(45,212,160,0.15); color: #2dd4a0; font-weight: 700; font-size: 13px; margin-right: 10px; }
    .step-title { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 12px; }
    .step p { color: #9ca3af; font-size: 14px; line-height: 1.6; }
    .step a { color: #2dd4a0; }
    .code-box { position: relative; background: #1a1f3d; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-top: 16px; }
    .code-box pre { padding: 20px; overflow-x: auto; font-size: 12px; line-height: 1.5; color: #e2e4e8; font-family: 'SF Mono', Menlo, monospace; max-height: 400px; overflow-y: auto; white-space: pre; }
    .copy-btn { position: absolute; top: 10px; right: 10px; background: #2dd4a0; color: #fff; border: none; border-radius: 50px; padding: 10px 24px; font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit; transition: all 0.2s; z-index: 2; }
    .copy-btn:hover { background: #25b888; transform: translateY(-1px); }
    .copy-btn.copied { background: #16a085; }
    .highlight { color: #2dd4a0; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Google Apps Script Setup</h1>
    <p class="subtitle">Follow these steps to connect file uploads to your Google Drive.</p>

    <div class="step">
      <div class="step-title"><span class="step-num">1</span> Open Google Apps Script</div>
      <p>Go to <a href="https://script.google.com" target="_blank">script.google.com</a> and click <span class="highlight">+ New project</span> (top left).</p>
    </div>

    <div class="step">
      <div class="step-title"><span class="step-num">2</span> Replace the default code</div>
      <p>Select all the default code in the editor (Ctrl+A or Cmd+A), delete it, then click the green button below to copy the code and paste it in (Ctrl+V or Cmd+V).</p>

      <div class="code-box">
        <button class="copy-btn" id="copy-btn" onclick="copyCode()">Copy Code</button>
        <pre id="script-code">/**
 * Straw Hut Media — Google Apps Script File Upload Handler
 */

var ROOT_FOLDER_NAME = "Straw Hut Onboarding Uploads";

function doPost(e) {
  try {
    var payload = JSON.parse(e.postData.contents);
    var company = payload.company || "Unknown";
    var files = payload.files || [];
    var category = payload.category || "general";

    var rootFolder = getOrCreateFolder(null, ROOT_FOLDER_NAME);
    var companyFolder = getOrCreateFolder(rootFolder, company);
    var categoryFolder = getOrCreateFolder(companyFolder, category);

    var results = [];

    for (var i = 0; i &lt; files.length; i++) {
      var file = files[i];
      var fileName = file.name || ("file_" + i);
      var mimeType = file.type || "application/octet-stream";
      var base64Data = file.dataUrl || "";

      var commaIdx = base64Data.indexOf(",");
      if (commaIdx > -1) {
        base64Data = base64Data.substring(commaIdx + 1);
      }

      if (!base64Data) {
        results.push({ name: fileName, error: "No file data" });
        continue;
      }

      var blob = Utilities.newBlob(Utilities.base64Decode(base64Data), mimeType, fileName);
      var driveFile = categoryFolder.createFile(blob);

      driveFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

      var fileId = driveFile.getId();
      var viewUrl = "https://drive.google.com/file/d/" + fileId + "/view";
      var thumbUrl = "https://drive.google.com/thumbnail?id=" + fileId + "&amp;sz=w400";

      results.push({
        name: fileName,
        type: mimeType,
        driveId: fileId,
        viewUrl: viewUrl,
        thumbUrl: thumbUrl
      });
    }

    return ContentService
      .createTextOutput(JSON.stringify({ success: true, files: results }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService
    .createTextOutput(JSON.stringify({ status: "ok", message: "Straw Hut upload endpoint is running." }))
    .setMimeType(ContentService.MimeType.JSON);
}

function getOrCreateFolder(parent, name) {
  var folders;
  if (parent) {
    folders = parent.getFoldersByName(name);
  } else {
    folders = DriveApp.getFoldersByName(name);
  }

  if (folders.hasNext()) {
    return folders.next();
  }

  if (parent) {
    return parent.createFolder(name);
  } else {
    return DriveApp.createFolder(name);
  }
}</pre>
      </div>
    </div>

    <div class="step">
      <div class="step-title"><span class="step-num">3</span> Save the project</div>
      <p>Click the <span class="highlight">floppy disk icon</span> (or press Ctrl+S / Cmd+S) to save.</p>
    </div>

    <div class="step">
      <div class="step-title"><span class="step-num">4</span> Deploy as a Web App</div>
      <p>Click <span class="highlight">Deploy</span> (top right) → <span class="highlight">New deployment</span>.<br>
      Click the gear icon next to "Select type" and choose <span class="highlight">Web app</span>.<br>
      Set <span class="highlight">"Execute as"</span> to <span class="highlight">Me</span>.<br>
      Set <span class="highlight">"Who has access"</span> to <span class="highlight">Anyone</span>.<br>
      Click <span class="highlight">Deploy</span>.</p>
    </div>

    <div class="step">
      <div class="step-title"><span class="step-num">5</span> Authorize access</div>
      <p>Google will ask you to authorize. Click <span class="highlight">Authorize access</span>, choose your account.<br>
      If you see "This app isn't verified", click <span class="highlight">Advanced</span> → <span class="highlight">Go to [project name] (unsafe)</span> → <span class="highlight">Allow</span>.</p>
    </div>

    <div class="step">
      <div class="step-title"><span class="step-num">6</span> Copy the Web App URL</div>
      <p>You'll see a URL like:<br>
      <code style="color:#2dd4a0; font-size:13px;">https://script.google.com/macros/s/AKfycbx.../exec</code><br><br>
      <strong style="color:#fff;">Copy that URL and send it to me.</strong> I'll plug it into the config and push the update.</p>
    </div>
  </div>

  <script>
    function copyCode() {
      var pre = document.getElementById("script-code");
      // Decode HTML entities back to actual characters for copying
      var text = pre.textContent;
      navigator.clipboard.writeText(text).then(function() {
        var btn = document.getElementById("copy-btn");
        btn.textContent = "Copied!";
        btn.classList.add("copied");
        setTimeout(function() {
          btn.textContent = "Copy Code";
          btn.classList.remove("copied");
        }, 3000);
      });
    }
  </script>
</body>
</html>
